<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Macro Dashboard ‚Äì Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --card: #111827;
      --card-alt: #0f172a;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --positive: #22c55e;
      --negative: #ef4444;
      --shadow-soft: 0 18px 35px rgba(15, 23, 42, 0.9);
      --radius-lg: 18px;
      --radius-xl: 26px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      width: 100%;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 0, #f97316, #7c2d12 55%, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fef3c7;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 12px 25px rgba(248, 113, 22, 0.5);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 650;
      letter-spacing: 0.04em;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .nav-link {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .nav-link span {
      font-size: 14px;
    }

    .nav-link--primary {
      border-color: rgba(249, 115, 22, 0.65);
      background: radial-gradient(circle at 0 0, rgba(249, 115, 22, 0.2), #020617);
      color: #fed7aa;
    }

    .nav-link:hover {
      border-color: var(--accent);
      color: #e5e7eb;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 18px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.12), #020617);
      border-radius: var(--radius-xl);
      padding: 18px 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at -10% -10%, rgba(249, 115, 22, 0.18), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--muted);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--muted);
    }

    .pill-positive .pill-dot {
      background: var(--positive);
    }

    .pill-negative .pill-dot {
      background: var(--negative);
    }

    .pill-neutral .pill-dot {
      background: var(--muted);
    }

    .pill-positive {
      border-color: rgba(34, 197, 94, 0.5);
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .pill-negative {
      border-color: rgba(239, 68, 68, 0.55);
      background: rgba(127, 29, 29, 0.28);
      color: #fecaca;
    }

    .summary-text {
      font-size: 13px;
      line-height: 1.5;
      color: #e5e7eb;
      margin-top: 8px;
    }

    .summary-text strong {
      color: #f9fafb;
    }

    .section-label {
      margin-top: 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .events-list {
      margin: 6px 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .event-item {
      display: flex;
      flex-direction: column;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .event-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .event-main {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 13px;
    }

    .event-country {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--muted);
    }

    .event-title {
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .event-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--muted);
    }

    .badge-high .badge-dot {
      background: #f97316;
    }

    .badge-high {
      border-color: rgba(249, 115, 22, 0.7);
      color: #fed7aa;
    }

    .badge-medium .badge-dot {
      background: #eab308;
    }

    .badge-medium {
      border-color: rgba(234, 179, 8, 0.6);
      color: #fef9c3;
    }

    .badge-low .badge-dot {
      background: #22c55e;
    }

    .badge-low {
      border-color: rgba(34, 197, 94, 0.5);
      color: #bbf7d0;
    }

    .event-impact {
      font-size: 11px;
      color: var(--muted);
    }

    .event-impact strong {
      color: #f9fafb;
    }

    .table-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.85);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: rgba(15, 23, 42, 0.95);
    }

    th,
    td {
      padding: 7px 9px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
    }

    th {
      font-weight: 500;
      color: var(--muted);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .perf-positive {
      color: var(--positive);
    }

    .perf-negative {
      color: var(--negative);
    }

    .perf-neutral {
      color: var(--muted);
    }

    .sentiment-grid {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.85);
    }

    .sentiment-header,
    .sentiment-row {
      display: grid;
      grid-template-columns: 70px repeat(5, minmax(0, 1fr));
      font-size: 11px;
    }

    .sentiment-header {
      background: rgba(15, 23, 42, 0.95);
      color: var(--muted);
      font-weight: 500;
    }

    .sentiment-cell,
    .sentiment-head-cell {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      border-right: 1px solid rgba(31, 41, 55, 0.8);
      min-height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .sentiment-row:last-child .sentiment-cell {
      border-bottom: none;
    }

    .sentiment-head-cell:last-child,
    .sentiment-row .sentiment-cell:last-child {
      border-right: none;
    }

    .sentiment-day {
      justify-content: flex-start;
      padding-left: 8px;
      color: var(--muted);
    }

    .sentiment-pill {
      padding: 2px 5px;
      border-radius: 999px;
      font-size: 10px;
      min-width: 26px;
      text-align: center;
    }

    .sentiment-strong-neg {
      background: rgba(127, 29, 29, 0.6);
      color: #fecaca;
    }

    .sentiment-neg {
      background: rgba(127, 29, 29, 0.35);
      color: #fecaca;
    }

    .sentiment-neutral {
      background: rgba(31, 41, 55, 0.9);
      color: var(--muted);
    }

    .sentiment-pos {
      background: rgba(22, 163, 74, 0.35);
      color: #bbf7d0;
    }

    .sentiment-strong-pos {
      background: rgba(22, 163, 74, 0.7);
      color: #ecfdf5;
    }

    .tagline {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .small-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-logo">
          Œî
        </div>
        <div class="brand-text">
          <div class="brand-title">STARK TRADING ‚Äì MACRO</div>
          <div class="brand-subtitle">R√©sum√© hebdo & contexte march√©</div>
        </div>
      </div>
      <div class="nav-links">
        <a href="index.html" class="nav-link">
          <span>‚¨Ö</span> Retour au dashboard principal
        </a>
        <button class="nav-link nav-link--primary" type="button" onclick="refreshMacro()">
          üîÑ Rafra√Æchir la vue
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- Colonne gauche : R√©sum√© & top events -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                Vue hebdomadaire
                <span class="card-title-badge" id="week-range">
                  Semaine en cours
                </span>
              </div>
              <div class="card-subtitle">
                Sentiment global & √©v√©nements macro qui ont driv√© le march√©.
              </div>
            </div>
            <div id="risk-pill" class="pill pill-neutral">
              <span class="pill-dot"></span>
              <span id="risk-label">Calcul en cours‚Ä¶</span>
            </div>
          </div>

          <div id="risk-comment" class="summary-text">
            R√©cup√©ration de la vue macro en cours‚Ä¶
          </div>

          <div class="section-label">√âV√âNEMENTS CL√âS DE LA SEMAINE</div>
          <ul id="events-list" class="events-list">
            <!-- Inject√© par JS -->
          </ul>

          <div class="section-label">MOUVEMENTS MARQUANTS</div>
          <ul id="moves-list" class="events-list">
            <!-- Inject√© par JS -->
          </ul>

          <p class="small-note">
            Les √©l√©ments ci-dessus restent descriptifs et ne constituent en aucun cas un conseil en investissement.
          </p>
        </div>
      </section>

      <!-- Colonne droite : perfs indices & grille sentiment -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                Indices & sentiment news
              </div>
              <div class="card-subtitle">
                Performance hebdo des actifs cl√©s & chaleur des news par th√®me.
              </div>
            </div>
          </div>

          <div class="section-label">PERFORMANCE HEBDO (INDICES SUIVIS)</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Symbole</th>
                  <th>Nom</th>
                  <th>Perf semaine</th>
                </tr>
              </thead>
              <tbody id="perf-body">
                <!-- Inject√© par JS -->
              </tbody>
            </table>
          </div>

          <div class="section-label">SENTIMENT NEWS PAR JOUR & TH√âMATIQUE</div>
          <div class="sentiment-grid">
            <div class="sentiment-header">
              <div class="sentiment-head-cell sentiment-day">Jour</div>
              <div class="sentiment-head-cell">Macro US</div>
              <div class="sentiment-head-cell">Macro Europe</div>
              <div class="sentiment-head-cell">Entreprises</div>
              <div class="sentiment-head-cell">G√©opolitique</div>
              <div class="sentiment-head-cell">Tech</div>
            </div>
            <div id="sentiment-body">
              <!-- Lignes inject√©es par JS -->
            </div>
          </div>

          <p class="tagline">
            La grille refl√®te le sentiment moyen des news capt√©es par th√©matique, sur la p√©riode de la semaine.
          </p>
        </div>
      </section>
    </div>
  </div>

  <script>
    const API_BASE = ""; // m√™me origine que l'API (Render), donc chemin relatif

    function formatDate(d) {
      const date = new Date(d);
      return date.toLocaleDateString("fr-FR", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
      });
    }

    function formatTime(d) {
      const date = new Date(d);
      return date.toLocaleTimeString("fr-FR", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function formatPct(x, digits = 2) {
      if (x === null || x === undefined || isNaN(x)) return "‚Äî";
      return x.toFixed(digits) + " %";
    }

    function setRiskPill(summary) {
      const pill = document.getElementById("risk-pill");
      const label = document.getElementById("risk-label");

      pill.classList.remove("pill-positive", "pill-negative", "pill-neutral");

      if (summary.risk_on === true) {
        pill.classList.add("pill-positive");
        label.textContent = "Biais risk-on";
      } else if (summary.risk_on === false) {
        pill.classList.add("pill-negative");
        label.textContent = "Biais risk-off";
      } else {
        pill.classList.add("pill-neutral");
        label.textContent = "Lecture neutre";
      }
    }

    function setWeekRange(summary) {
      const span = document.getElementById("week-range");
      const start = new Date(summary.start);
      const end = new Date(summary.end);
      const opts = { day: "2-digit", month: "2-digit" };
      span.textContent =
        start.toLocaleDateString("fr-FR", opts) +
        " ‚Üí " +
        end.toLocaleDateString("fr-FR", opts);
    }

    function renderRiskComment(summary) {
      const el = document.getElementById("risk-comment");
      el.textContent = summary.risk_comment || "Pas de commentaire disponible.";
    }

    function renderTopEvents(summary) {
      const list = document.getElementById("events-list");
      list.innerHTML = "";

      if (!summary.top_events || summary.top_events.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Aucun √©v√©nement majeur identifi√© pour cette semaine.";
        li.style.fontSize = "12px";
        li.style.color = "#9ca3af";
        list.appendChild(li);
        return;
      }

      summary.top_events.forEach((ev) => {
        const li = document.createElement("li");
        li.className = "event-item";

        const top = document.createElement("div");
        top.className = "event-top";

        const main = document.createElement("div");
        main.className = "event-main";

        const country = document.createElement("span");
        country.className = "event-country";
        country.textContent = ev.country || "‚Äî";

        const title = document.createElement("span");
        title.className = "event-title";
        title.textContent = ev.title || "√âv√©nement";

        main.appendChild(country);
        main.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "event-meta";

        if (ev.datetime) {
          const dt = document.createElement("span");
          dt.textContent = formatDate(ev.datetime) + " ‚Ä¢ " + formatTime(ev.datetime);
          meta.appendChild(dt);
        }

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.classList.add(
          ev.importance === "high"
            ? "badge-high"
            : ev.importance === "medium"
            ? "badge-medium"
            : "badge-low"
        );

        const dot = document.createElement("span");
        dot.className = "badge-dot";
        badge.appendChild(dot);

        const txt = document.createElement("span");
        txt.textContent =
          ev.importance === "high"
            ? "MAJEUR"
            : ev.importance === "medium"
            ? "SIGNIFICATIF"
            : "SECONDAIRE";
        badge.appendChild(txt);

        meta.appendChild(badge);

        top.appendChild(main);
        top.appendChild(meta);

        const impact = document.createElement("div");
        impact.className = "event-impact";
        let text = "";
        if (ev.actual !== null && ev.actual !== undefined && !isNaN(ev.actual)) {
          text += `Actual: ${ev.actual}`;
          if (ev.unit) text += ` ${ev.unit}`;
        }
        if (
          ev.consensus !== null &&
          ev.consensus !== undefined &&
          !isNaN(ev.consensus)
        ) {
          if (text) text += " ‚Ä¢ ";
          text += `Consensus: ${ev.consensus}`;
          if (ev.unit) text += ` ${ev.unit}`;
        }
        if (
          ev.previous !== null &&
          ev.previous !== undefined &&
          !isNaN(ev.previous)
        ) {
          if (text) text += " ‚Ä¢ ";
          text += `Pr√©c√©dent: ${ev.previous}`;
          if (ev.unit) text += ` ${ev.unit}`;
        }

        if (text) {
          impact.innerHTML = `<strong>Donn√©es :</strong> ${text}`;
        } else {
          impact.textContent = "Donn√©es d√©taill√©es non disponibles.";
        }

        li.appendChild(top);
        li.appendChild(impact);
        list.appendChild(li);
      });
    }

    function renderTopMoves(summary) {
      const list = document.getElementById("moves-list");
      list.innerHTML = "";

      if (!summary.top_moves || summary.top_moves.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Aucun mouvement marquant remont√© pour cette semaine.";
        li.style.fontSize = "12px";
        li.style.color = "#9ca3af";
        list.appendChild(li);
        return;
      }

      summary.top_moves.forEach((mv) => {
        const li = document.createElement("li");
        li.className = "event-item";

        const top = document.createElement("div");
        top.className = "event-top";

        const desc = document.createElement("div");
        desc.className = "event-title";
        desc.textContent = mv.description || "Mouvement";

        const meta = document.createElement("div");
        meta.className = "event-meta";

        const asset = document.createElement("span");
        asset.textContent = mv.asset || "‚Äî";

        const perf = document.createElement("span");
        const val = mv.move_pct || 0;
        const sign = val > 0 ? "+" : "";
        perf.textContent = sign + val.toFixed(2) + " %";

        perf.style.color =
          val > 0
            ? "var(--positive)"
            : val < 0
            ? "var(--negative)"
            : "var(--muted)";

        meta.appendChild(asset);
        meta.appendChild(perf);

        top.appendChild(desc);
        top.appendChild(meta);

        li.appendChild(top);
        list.appendChild(li);
      });
    }

    function renderPerfTable(data) {
      const body = document.getElementById("perf-body");
      body.innerHTML = "";

      if (!data.asset_performances || data.asset_performances.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "Pas de donn√©es de performance disponibles.";
        td.style.fontSize = "12px";
        td.style.color = "#9ca3af";
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }

      data.asset_performances.forEach((a) => {
        const tr = document.createElement("tr");

        const tdSym = document.createElement("td");
        tdSym.textContent = a.symbol || "‚Äî";

        const tdName = document.createElement("td");
        tdName.textContent = a.name || "‚Äî";

        const tdRet = document.createElement("td");
        const val = a.return_pct || 0;
        const sign = val > 0 ? "+" : "";
        tdRet.textContent = sign + val.toFixed(2) + " %";

        tdRet.className =
          val > 0
            ? "perf-positive"
            : val < 0
            ? "perf-negative"
            : "perf-neutral";

        tr.appendChild(tdSym);
        tr.appendChild(tdName);
        tr.appendChild(tdRet);
        body.appendChild(tr);
      });
    }

    function sentimentClassFromValue(avg) {
      if (avg === null || avg === undefined || isNaN(avg)) return "sentiment-neutral";
      if (avg <= -0.5) return "sentiment-strong-neg";
      if (avg < -0.1) return "sentiment-neg";
      if (avg < 0.1 && avg > -0.1) return "sentiment-neutral";
      if (avg < 0.5) return "sentiment-pos";
      return "sentiment-strong-pos";
    }

    function renderSentimentGrid(data) {
      const container = document.getElementById("sentiment-body");
      container.innerHTML = "";

      if (!data.sentiment_grid || data.sentiment_grid.length === 0) {
        const row = document.createElement("div");
        row.className = "sentiment-row";
        const cell = document.createElement("div");
        cell.className = "sentiment-cell sentiment-day";
        cell.textContent = "Pas de donn√©es de sentiment.";
        cell.style.gridColumn = "1 / -1";
        container.appendChild(row);
        row.appendChild(cell);
        return;
      }

      const bucketsOrder = [
        "macro_us",
        "macro_europe",
        "companies",
        "geopolitics",
        "tech",
      ];

      const groupedByDay = {};
      data.sentiment_grid.forEach((cell) => {
        const d = cell.date;
        if (!groupedByDay[d]) groupedByDay[d] = {};
        groupedByDay[d][cell.bucket] = cell;
      });

      const days = Object.keys(groupedByDay).sort();

      const dayLabels = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];

      days.forEach((d) => {
        const row = document.createElement("div");
        row.className = "sentiment-row";

        const dayCell = document.createElement("div");
        dayCell.className = "sentiment-cell sentiment-day";

        const dateObj = new Date(d);
        const dow = dayLabels[dateObj.getDay()] || "";
        dayCell.textContent =
          dow +
          " " +
          dateObj.toLocaleDateString("fr-FR", {
            day: "2-digit",
            month: "2-digit",
          });

        row.appendChild(dayCell);

        bucketsOrder.forEach((bucket) => {
          const info = groupedByDay[d][bucket];
          const cellDiv = document.createElement("div");
          cellDiv.className = "sentiment-cell";

          if (!info) {
            cellDiv.textContent = "‚Äî";
            cellDiv.classList.add("sentiment-neutral");
          } else {
            const avg = info.sentiment;
            const count = info.news_count || 0;
            const pill = document.createElement("div");
            pill.className =
              "sentiment-pill " + sentimentClassFromValue(avg);

            if (count === 0) {
              pill.textContent = "‚Äî";
            } else if (avg === null || avg === undefined || isNaN(avg)) {
              pill.textContent = count;
            } else {
              pill.textContent = (avg > 0 ? "+" : "") + avg.toFixed(2);
            }

            cellDiv.appendChild(pill);
          }

          row.appendChild(cellDiv);
        });

        container.appendChild(row);
      });
    }

    async function refreshMacro() {
      try {
        const [summaryRes, rawRes] = await Promise.all([
          fetch(API_BASE + "/api/macro/week/summary"),
          fetch(API_BASE + "/api/macro/week/raw"),
        ]);

        if (!summaryRes.ok || !rawRes.ok) {
          throw new Error("Erreur HTTP sur les endpoints macro");
        }

        const summary = await summaryRes.json();
        const raw = await rawRes.json();

        setWeekRange(summary);
        setRiskPill(summary);
        renderRiskComment(summary);
        renderTopEvents(summary);
        renderTopMoves(summary);
        renderPerfTable(raw);
        renderSentimentGrid(raw);
      } catch (err) {
        console.error("Erreur refreshMacro:", err);
        const el = document.getElementById("risk-comment");
        el.textContent =
          "Impossible de r√©cup√©rer la vue macro pour le moment. V√©rifie l'API Render.";
      }
    }

    // Chargement initial
    window.addEventListener("DOMContentLoaded", () => {
      refreshMacro();
    });
  </script>
</body>
</html>
