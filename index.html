<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>STARK TRADING DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --card: #020617;
      --card-alt: #111827;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.15);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --border: #1f2937;
      --card-radius: 18px;
      --transition-fast: 0.15s ease-out;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      min-height: 100%;
    }

    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 50%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      width: 100%;
    }

    /* HEADER G√âN√âRIQUE */

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 0, #f97316, #7c2d12 55%, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fef3c7;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 12px 25px rgba(248, 113, 22, 0.5);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 650;
      letter-spacing: 0.04em;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .nav-link, .btn-secondary, .btn-primary {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: border-color var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    .nav-link span {
      font-size: 14px;
    }

    .nav-link--primary, .btn-primary {
      border-color: rgba(249, 115, 22, 0.7);
      background: radial-gradient(circle at 0 0, rgba(249, 115, 22, 0.18), #020617);
      color: #fed7aa;
    }

    .nav-link:hover, .btn-secondary:hover, .btn-primary:hover {
      border-color: var(--accent);
      color: #e5e7eb;
      transform: translateY(-1px);
    }

    .btn-secondary {
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    /* CARTES G√âN√âRALES */

    .card {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.14), #020617);
      border-radius: 22px;
      padding: 18px 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at -10% -10%, rgba(249, 115, 22, 0.18), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-muted);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .section-label {
      margin-top: 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .summary-text {
      font-size: 13px;
      line-height: 1.5;
      color: #e5e7eb;
      margin-top: 8px;
    }

    .summary-text strong {
      color: #f9fafb;
    }

    .tagline, .small-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--text-muted);
    }

    .pill-positive .pill-dot {
      background: var(--success);
    }

    .pill-negative .pill-dot {
      background: var(--danger);
    }

    .pill-neutral .pill-dot {
      background: var(--text-muted);
    }

    .pill-positive {
      border-color: rgba(34, 197, 94, 0.5);
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .pill-negative {
      border-color: rgba(239, 68, 68, 0.55);
      background: rgba(127, 29, 29, 0.28);
      color: #fecaca;
    }

    .pill-neutral {
      border-color: rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
    }

    /* GRID LAYOUTS */

    .grid-two {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 18px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .grid-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.3fr);
      gap: 18px;
      margin-top: 10px;
    }

    @media (max-width: 1000px) {
      .grid-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .grid-bottom {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap: 18px;
      margin-top: 16px;
    }

    @media (max-width: 1000px) {
      .grid-bottom {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* MACRO WEEKLY (HAUT DE PAGE) */

    .events-list {
      margin: 6px 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .event-item {
      display: flex;
      flex-direction: column;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.94);
      border: 1px solid rgba(31, 41, 55, 0.96);
    }

    .event-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .event-main {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 13px;
    }

    .event-country {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-muted);
    }

    .event-title {
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .event-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--text-muted);
    }

    .badge-high .badge-dot { background: #f97316; }
    .badge-high { border-color: rgba(249, 115, 22, 0.7); color: #fed7aa; }
    .badge-medium .badge-dot { background: #eab308; }
    .badge-medium { border-color: rgba(234, 179, 8, 0.6); color: #fef9c3; }
    .badge-low .badge-dot { background: #22c55e; }
    .badge-low { border-color: rgba(34, 197, 94, 0.5); color: #bbf7d0; }

    .event-impact {
      font-size: 11px;
      color: var(--text-muted);
    }

    .event-impact strong { color: #f9fafb; }

    .table-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead { background: rgba(15, 23, 42, 0.98); }

    th, td {
      padding: 7px 9px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
    }

    tbody tr:last-child td { border-bottom: none; }

    .perf-positive { color: var(--success); }
    .perf-negative { color: var(--danger); }
    .perf-neutral { color: var(--text-muted); }

    .sentiment-grid {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.9);
    }

    .sentiment-header, .sentiment-row {
      display: grid;
      grid-template-columns: 70px repeat(5, minmax(0, 1fr));
      font-size: 11px;
    }

    .sentiment-header {
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-muted);
      font-weight: 500;
    }

    .sentiment-cell, .sentiment-head-cell {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      border-right: 1px solid rgba(31, 41, 55, 0.9);
      min-height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .sentiment-row:last-child .sentiment-cell { border-bottom: none; }
    .sentiment-head-cell:last-child, .sentiment-row .sentiment-cell:last-child { border-right: none; }

    .sentiment-day {
      justify-content: flex-start;
      padding-left: 8px;
      color: var(--text-muted);
    }

    .sentiment-pill {
      padding: 2px 5px;
      border-radius: 999px;
      font-size: 10px;
      min-width: 26px;
      text-align: center;
    }

    .sentiment-strong-neg { background: rgba(127, 29, 29, 0.6); color: #fecaca; }
    .sentiment-neg { background: rgba(127, 29, 29, 0.35); color: #fecaca; }
    .sentiment-neutral { background: rgba(31, 41, 55, 0.9); color: var(--text-muted); }
    .sentiment-pos { background: rgba(22, 163, 74, 0.35); color: #bbf7d0; }
    .sentiment-strong-pos { background: rgba(22, 163, 74, 0.7); color: #ecfdf5; }

    /* DASHBOARD LIVE */

    .top-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .top-line-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .top-line-title {
      font-size: 17px;
      font-weight: 650;
      letter-spacing: 0.03em;
    }

    .top-line-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .macro-bias-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
    }

    .macro-bias-chip strong { color: #f9fafb; }

    .badge-beta {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(249, 115, 22, 0.7);
      background: rgba(30, 64, 175, 0.5);
      color: #e0f2fe;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .contract-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .contract-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .main-price {
      font-size: 26px;
      font-weight: 650;
    }

    .main-change-pos { color: var(--success); font-size: 13px; margin-left: 6px; }
    .main-change-neg { color: var(--danger); font-size: 13px; margin-left: 6px; }
    .main-change-neutral { color: var(--text-muted); font-size: 13px; margin-left: 6px; }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    @media (max-width: 700px) {
      .mini-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .mini-asset {
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 12px;
    }

    .mini-asset-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 4px;
    }

    .mini-asset-name {
      font-size: 11px;
      color: var(--text-muted);
    }

    .mini-asset-change-pos { color: var(--success); font-size: 11px; }
    .mini-asset-change-neg { color: var(--danger); font-size: 11px; }
    .mini-asset-change-neutral { color: var(--text-muted); font-size: 11px; }

    .mini-asset-price {
      font-size: 14px;
      font-weight: 500;
    }

    .mini-asset-comment {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .status-line {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-ok {
      color: #4ade80;
    }

    .ia-output {
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 12px;
      color: #e5e7eb;
      max-height: 280px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .select-asset {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
    }

    /* NEWS IA NOUVELLE VERSION */

    .news-top-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .news-last-update {
      margin-left: auto;
      font-size: 11px;
      color: var(--text-muted);
    }

    .news-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 14px;
      margin-top: 6px;
    }

    @media (max-width: 900px) {
      .news-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .news-global { min-height: 120px; }

    .news-keypoints {
      margin-top: 8px;
      list-style: disc;
      padding-left: 16px;
      font-size: 12px;
      color: #d1d5db;
    }

    .news-keypoints li { margin-bottom: 3px; }

    .news-impacts {
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.92);
    }

    .news-impacts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .news-asset-select {
      min-width: 150px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
    }

    .news-impact-panel { margin-top: 4px; }

    .news-impact-badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
      margin-bottom: 6px;
    }

    .news-impact-badge.bullish {
      border-color: rgba(34, 197, 94, 0.6);
      color: #bbf7d0;
    }

    .news-impact-badge.bearish {
      border-color: rgba(239, 68, 68, 0.6);
      color: #fecaca;
    }

    .news-impact-badge.neutral {
      border-color: rgba(55, 65, 81, 0.9);
      color: var(--text-muted);
    }

    .news-impact-comment {
      font-size: 12px;
      color: #e5e7eb;
      line-height: 1.5;
    }

    .news-asset-helper {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .news-footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* CALENDRIER √âCO */

    .calendar-columns {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px;
      margin-top: 6px;
    }

    @media (max-width: 700px) {
      .calendar-columns {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .calendar-day-block {
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.95);
      font-size: 12px;
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
    }

    .calendar-table th,
    .calendar-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .calendar-table th {
      color: var(--text-muted);
      font-weight: 500;
      text-align: left;
    }

    .calendar-impact-high { color: #f97316; }
    .calendar-impact-medium { color: #eab308; }
    .calendar-impact-low { color: #22c55e; }
  </style>
</head>
<body>
  <!-- SECTION 1 : MACRO HEBDO -->
  <div id="macro-weekly" class="page">
    <header>
      <div class="brand">
        <div class="brand-logo">Œî</div>
        <div class="brand-text">
          <div class="brand-title">STARK TRADING ‚Äì MACRO</div>
          <div class="brand-subtitle">
            R√©sum√© hebdo &amp; contexte march√©
            <span id="macro-last-update" style="margin-left:6px; color:#6b7280; font-size:11px;"></span>
          </div>
        </div>
      </div>
      <div class="nav-links">
        <a href="#live-dashboard" class="nav-link">
          <span>‚¨á</span> Aller au dashboard trading
        </a>
        <button class="nav-link nav-link--primary" type="button" onclick="refreshMacroWeek()">
          üîÑ Rafra√Æchir la vue
        </button>
      </div>
    </header>

    <div class="grid-two">
      <!-- Colonne gauche : r√©sum√© & events -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                Vue hebdomadaire
                <span class="card-title-badge" id="week-range">Semaine en cours</span>
              </div>
              <div class="card-subtitle">
                Sentiment global &amp; √©v√©nements macro qui ont driv√© le march√©.
              </div>
            </div>
            <div id="risk-pill" class="pill pill-neutral">
              <span class="pill-dot"></span>
              <span id="risk-label">Lecture neutre</span>
            </div>
          </div>

          <div id="risk-comment" class="summary-text">
            R√©cup√©ration de la vue macro en cours‚Ä¶
          </div>

          <div class="section-label">√âV√âNEMENTS CL√âS DE LA SEMAINE</div>
          <ul id="events-list" class="events-list"></ul>

          <div class="section-label">MOUVEMENTS MARQUANTS</div>
          <ul id="moves-list" class="events-list"></ul>

          <p class="small-note">
            Synth√®se hebdomadaire g√©n√©r√©e pour ton suivi des march√©s.
          </p>
        </div>
      </section>

      <!-- Colonne droite : sentiment grid uniquement -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Sentiment news &amp; th√©matiques</div>
              <div class="card-subtitle">
                Grille hebdo du sentiment moyen des news par grande th√©matique.
              </div>
            </div>
          </div>

          <div class="section-label">SENTIMENT NEWS PAR JOUR &amp; TH√âMATIQUE</div>
          <div class="sentiment-grid">
            <div class="sentiment-header">
              <div class="sentiment-head-cell sentiment-day">Jour</div>
              <div class="sentiment-head-cell">Macro US</div>
              <div class="sentiment-head-cell">Macro Europe</div>
              <div class="sentiment-head-cell">Entreprises</div>
              <div class="sentiment-head-cell">G√©opolitique</div>
              <div class="sentiment-head-cell">Tech</div>
            </div>
            <div id="sentiment-body"></div>
          </div>

          <p class="tagline">
            La grille refl√®te le sentiment moyen des news capt√©es par th√©matique, sur la p√©riode de la semaine.
          </p>
        </div>
      </section>
    </div>
  </div>

  <!-- SECTION 2 : DASHBOARD LIVE -->
  <div id="live-dashboard" class="page">
    <header>
      <div class="brand">
        <div class="brand-logo">A</div>
        <div class="brand-text">
          <div class="brand-title">STARK TRADING DASHBOARD</div>
          <div class="brand-subtitle">
            Vue synth√©tique des march√©s ‚Äî ES, NQ, BTC, CL, GC
          </div>
        </div>
      </div>
      <div class="nav-links">
        <span class="badge-beta">B√äTA ‚Äì BACKEND RENDER</span>
      </div>
    </header>

    <div class="top-line">
      <div class="top-line-main">
        <div class="top-line-title">Contrat principal ‚Äì <span id="main-symbol-label">ES S&amp;P 500 Future</span></div>
        <div class="top-line-sub">
          Lecture globale du march√© &amp; biais macro.
        </div>
      </div>
      <div id="macro-bias-chip" class="macro-bias-chip">
        <strong>Biais MACRO GLOBAL</strong> <span id="macro-bias-text">Lecture neutre pour le moment.</span>
      </div>
    </div>

    <div class="grid-main">
      <!-- Bloc gauche : prix & indices -->
      <section class="card">
        <div class="card-inner">
          <div class="contract-title">ES ‚Äî S&amp;P 500 Future</div>
          <div class="contract-sub">Prix spot &amp; variation depuis la derni√®re bougie.</div>

          <div style="margin-top:10px;">
            <span id="main-price" class="main-price">0.00</span>
            <span id="main-change" class="main-change-neutral">0.00 %</span>
          </div>

          <div class="section-label" style="margin-top:10px;">LECTURE GLOBALE EN COURS‚Ä¶</div>

          <div class="mini-grid" id="mini-assets">
            <!-- tuiles inject√©es -->
          </div>

          <div class="status-line">
            <span class="status-ok" id="backend-status">
              ‚óè Backend Render en ligne ‚Äì actualisation auto toutes les 15 s
            </span>
            <span id="market-last-update">Derni√®re mise √† jour : ‚Äî</span>
          </div>
        </div>
      </section>

      <!-- Bloc droite : Assistant IA -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                Assistant Stark ‚Äì Analyse IA
              </div>
              <div class="card-subtitle">
                G√©n√®re une analyse synth√©tique pour l'actif s√©lectionn√© √† partir des donn√©es temps r√©el r√©cup√©r√©es par ton backend FastAPI.
              </div>
            </div>
          </div>

          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <select id="ia-asset-select" class="select-asset">
              <option value="ES">ES ‚Äì S&amp;P 500 Future</option>
              <option value="NQ">NQ ‚Äì Nasdaq 100 Future</option>
              <option value="BTC">BTC ‚Äì Bitcoin</option>
              <option value="CL">CL ‚Äì Crude Oil (WTI)</option>
              <option value="GC">GC ‚Äì Gold</option>
            </select>
            <button id="ia-run-btn" class="btn-primary" type="button">‚ö° Analyser avec l'IA</button>
          </div>

          <div id="ia-output" class="ia-output">
            S√©lectionne un actif puis clique sur ¬´ Analyser avec l'IA ¬ª pour g√©n√©rer une analyse de march√© structur√©e (global, swing, intraday, sc√©narios).
          </div>

          <p class="small-note">
            L'assistant IA combine les donn√©es techniques et le contexte global du march√© pour g√©n√©rer une synth√®se exploitable. Il ne fournit pas de signaux de trade ou de conseils d'investissement.
          </p>
        </div>
      </section>
    </div>

    <!-- Bas : Performance, News IA, Calendrier -->
    <div class="grid-bottom">
      <!-- Performance indices (√©largi c√¥t√© backend) -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Performance des indices</div>
              <div class="card-subtitle">
                Donn√©es au <span id="perf-as-of">‚Äî</span>.
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Indice / Actif</th>
                  <th>Jour</th>
                  <th>Semaine</th>
                  <th>Mois</th>
                </tr>
              </thead>
              <tbody id="perf-summary-body">
                <!-- lignes -->
              </tbody>
            </table>
          </div>

          <p class="small-note" id="perf-error" style="display:none; color:#fca5a5; margin-top:6px;">
            Erreur lors du chargement des performances.
          </p>
        </div>
      </section>

      <!-- News IA + Calendrier -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <!-- NEWS IA -->
        <section class="card card-news">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">News &amp; Sentiment IA</div>
                <div class="card-subtitle">
                  Lecture synth√©tique des derni√®res news macro / march√© √† partir des flux IA.
                </div>
              </div>
              <button id="news-refresh-btn" class="btn-secondary" type="button">
                üîÑ Rafra√Æchir l'analyse
              </button>
            </div>

            <!-- Ligne tonalit√© / volatilit√© -->
            <div class="news-top-row">
              <span id="news-tone-pill" class="pill pill-neutral">
                <span class="pill-dot"></span>
                <span id="news-tone-label">Tonalit√© en cours‚Ä¶</span>
              </span>
              <span id="news-vol-pill" class="pill pill-neutral">
                <span class="pill-dot"></span>
                <span id="news-vol-label">Volatilit√© : ‚Äî</span>
              </span>
              <span id="news-last-update" class="news-last-update">Derni√®re analyse : ‚Äî</span>
            </div>

            <!-- Layout : bloc news + bloc impacts -->
            <div class="news-layout">
              <div class="news-global">
                <h4 class="section-label">R√âSUM√â MACRO (NEWS)</h4>
                <p id="news-summary-text" class="summary-text">
                  Impossible de r√©cup√©rer l'analyse des news pour le moment.
                </p>

                <ul id="news-keypoints" class="news-keypoints"></ul>
              </div>

              <div class="news-impacts">
                <div class="news-impacts-header">
                  <h4 class="section-label">IMPACT PAR INDICE / ACTIF</h4>
                  <select id="news-asset-select" class="news-asset-select"></select>
                </div>

                <div id="news-impact-panel" class="news-impact-panel">
                  <div class="news-impact-badge neutral" id="news-impact-bias">
                    Biais : ‚Äî
                  </div>
                  <p id="news-impact-comment" class="news-impact-comment">
                    S√©lectionne un indice dans la liste pour voir l'interpr√©tation de l'IA.
                  </p>
                </div>

                <p class="news-asset-helper">
                  Indices suivis : ES (S&amp;P 500), NQ (Nasdaq 100), BTC (Bitcoin), CL (WTI), GC (Gold).  
                  Tu peux en ajouter d'autres c√¥t√© backend, ils s'afficheront ici automatiquement.
                </p>
              </div>
            </div>

            <div class="news-footer">
              <span id="news-source-label" class="news-source-label">Source : ‚Äî</span>
            </div>
          </div>
        </section>

        <!-- Calendrier √©conomique -->
        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">Calendrier √©conomique</div>
                <div class="card-subtitle">
                  Principales publications macro du jour et des prochains jours (UTC).
                </div>
              </div>
            </div>

            <div class="calendar-columns">
              <div class="calendar-day-block">
                <div class="section-label">AUJOURD'HUI</div>
                <table class="calendar-table">
                  <thead>
                    <tr>
                      <th>Heure</th>
                      <th>Pays</th>
                      <th>√âv√©nement</th>
                      <th>Impact</th>
                    </tr>
                  </thead>
                  <tbody id="calendar-today-body">
                    <tr>
                      <td colspan="4" style="font-size:11px; color:#9ca3af;">
                        Chargement du calendrier d'aujourd'hui‚Ä¶
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="calendar-day-block">
                <div class="section-label">PROCHAINS JOURS</div>
                <table class="calendar-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Pays</th>
                      <th>√âv√©nement</th>
                      <th>Impact</th>
                    </tr>
                  </thead>
                  <tbody id="calendar-next-body">
                    <tr>
                      <td colspan="4" style="font-size:11px; color:#9ca3af;">
                        Chargement des publications des prochains jours‚Ä¶
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "";

    function sentimentClassFromValue(avg) {
      if (avg === null || avg === undefined || isNaN(avg)) return "sentiment-neutral";
      if (avg <= -0.5) return "sentiment-strong-neg";
      if (avg < -0.1) return "sentiment-neg";
      if (avg > -0.1 && avg < 0.1) return "sentiment-neutral";
      if (avg < 0.5) return "sentiment-pos";
      return "sentiment-strong-pos";
    }

    /* ---------- MACRO HEBDO (SECTION HAUT) ---------- */

    function setRiskPillWeekly(summary) {
      const pill = document.getElementById("risk-pill");
      const label = document.getElementById("risk-label");
      pill.classList.remove("pill-positive", "pill-negative", "pill-neutral");

      if (summary.risk_on === true) {
        pill.classList.add("pill-positive");
        label.textContent = "Biais risk-on";
      } else if (summary.risk_on === false) {
        pill.classList.add("pill-negative");
        label.textContent = "Biais risk-off";
      } else {
        pill.classList.add("pill-neutral");
        label.textContent = "Lecture neutre";
      }
    }

    function setWeekRange(summary) {
      const span = document.getElementById("week-range");
      const start = new Date(summary.start);
      const end = new Date(summary.end);
      const opts = { day: "2-digit", month: "2-digit" };
      span.textContent =
        start.toLocaleDateString("fr-FR", opts) +
        " ‚Üí " +
        end.toLocaleDateString("fr-FR", opts);

      const lastUpdate = document.getElementById("macro-last-update");
      lastUpdate.textContent =
        "(Semaine " +
        start.toLocaleDateString("fr-FR", opts) +
        " ‚Üí " +
        end.toLocaleDateString("fr-FR", opts) +
        ")";
    }

    function renderRiskComment(summary) {
      const el = document.getElementById("risk-comment");
      el.textContent = summary.risk_comment || "Pas de commentaire disponible.";
    }

    function renderTopEvents(summary) {
      const list = document.getElementById("events-list");
      list.innerHTML = "";

      if (!summary.top_events || summary.top_events.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Aucun √©v√©nement majeur identifi√© pour cette semaine.";
        li.style.fontSize = "12px";
        li.style.color = "#9ca3af";
        list.appendChild(li);
        return;
      }

      summary.top_events.forEach((ev) => {
        const li = document.createElement("li");
        li.className = "event-item";

        const top = document.createElement("div");
        top.className = "event-top";

        const main = document.createElement("div");
        main.className = "event-main";

        const country = document.createElement("span");
        country.className = "event-country";
        country.textContent = ev.country || "‚Äî";

        const title = document.createElement("span");
        title.className = "event-title";
        title.textContent = ev.title || "√âv√©nement";

        main.appendChild(country);
        main.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "event-meta";

        if (ev.datetime) {
          const date = new Date(ev.datetime);
          const txt =
            date.toLocaleDateString("fr-FR", { day: "2-digit", month: "2-digit" }) +
            " ‚Ä¢ " +
            date.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
          const dt = document.createElement("span");
          dt.textContent = txt;
          meta.appendChild(dt);
        }

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.classList.add(
          ev.importance === "high"
            ? "badge-high"
            : ev.importance === "medium"
            ? "badge-medium"
            : "badge-low"
        );

        const dot = document.createElement("span");
        dot.className = "badge-dot";
        badge.appendChild(dot);

        const txt = document.createElement("span");
        txt.textContent =
          ev.importance === "high"
            ? "MAJEUR"
            : ev.importance === "medium"
            ? "SIGNIFICATIF"
            : "SECONDAIRE";
        badge.appendChild(txt);

        meta.appendChild(badge);
        top.appendChild(main);
        top.appendChild(meta);

        const impact = document.createElement("div");
        impact.className = "event-impact";
        impact.textContent = ev.impact_comment || "Impact macro / march√© non pr√©cis√©.";

        li.appendChild(top);
        li.appendChild(impact);
        list.appendChild(li);
      });
    }

    function renderTopMoves(summary) {
      const list = document.getElementById("moves-list");
      list.innerHTML = "";

      if (!summary.top_moves || summary.top_moves.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Aucun mouvement marquant remont√© pour cette semaine.";
        li.style.fontSize = "12px";
        li.style.color = "#9ca3af";
        list.appendChild(li);
        return;
      }

      summary.top_moves.forEach((mv) => {
        const li = document.createElement("li");
        li.className = "event-item";

        const top = document.createElement("div");
        top.className = "event-top";

        const desc = document.createElement("div");
        desc.className = "event-title";
        desc.textContent = mv.description || "Mouvement";

        const meta = document.createElement("div");
        meta.className = "event-meta";

        const asset = document.createElement("span");
        asset.textContent = mv.asset || "‚Äî";

        const perf = document.createElement("span");
        const val = mv.move_pct || 0;
        const sign = val > 0 ? "+" : "";
        perf.textContent = sign + val.toFixed(2) + " %";
        perf.style.color =
          val > 0
            ? "var(--success)"
            : val < 0
            ? "var(--danger)"
            : "var(--text-muted)";

        meta.appendChild(asset);
        meta.appendChild(perf);

        top.appendChild(desc);
        top.appendChild(meta);

        li.appendChild(top);
        list.appendChild(li);
      });
    }

    function renderSentimentGrid(data) {
      const container = document.getElementById("sentiment-body");
      container.innerHTML = "";

      if (!data.sentiment_grid || data.sentiment_grid.length === 0) {
        const row = document.createElement("div");
        row.className = "sentiment-row";
        const cell = document.createElement("div");
        cell.className = "sentiment-cell sentiment-day";
        cell.textContent = "Pas de donn√©es de sentiment.";
        cell.style.gridColumn = "1 / -1";
        row.appendChild(cell);
        container.appendChild(row);
        return;
      }

      const bucketsOrder = ["macro_us", "macro_europe", "companies", "geopolitics", "tech"];
      const groupedByDay = {};
      data.sentiment_grid.forEach((cell) => {
        const d = cell.date;
        if (!groupedByDay[d]) groupedByDay[d] = {};
        groupedByDay[d][cell.bucket] = cell;
      });

      const days = Object.keys(groupedByDay).sort();
      const dayLabels = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];

      days.forEach((d) => {
        const row = document.createElement("div");
        row.className = "sentiment-row";

        const dayCell = document.createElement("div");
        dayCell.className = "sentiment-cell sentiment-day";
        const dateObj = new Date(d);
        const dow = dayLabels[dateObj.getDay()] || "";
        dayCell.textContent =
          dow +
          " " +
          dateObj.toLocaleDateString("fr-FR", { day: "2-digit", month: "2-digit" });
        row.appendChild(dayCell);

        bucketsOrder.forEach((bucket) => {
          const info = groupedByDay[d][bucket];
          const cellDiv = document.createElement("div");
          cellDiv.className = "sentiment-cell";

          if (!info) {
            cellDiv.textContent = "‚Äî";
            cellDiv.classList.add("sentiment-neutral");
          } else {
            const avg = info.sentiment;
            const count = info.news_count || 0;
            const pill = document.createElement("div");
            pill.className = "sentiment-pill " + sentimentClassFromValue(avg);

            if (count === 0) {
              pill.textContent = "‚Äî";
            } else if (avg === null || avg === undefined || isNaN(avg)) {
              pill.textContent = count;
            } else {
              pill.textContent = (avg > 0 ? "+" : "") + avg.toFixed(2);
            }
            cellDiv.appendChild(pill);
          }

          row.appendChild(cellDiv);
        });

        container.appendChild(row);
      });
    }

    async function refreshMacroWeek() {
      try {
        const [summaryRes, rawRes] = await Promise.all([
          fetch(API_BASE + "/api/macro/week/summary"),
          fetch(API_BASE + "/api/macro/week/raw"),
        ]);

        if (!summaryRes.ok || !rawRes.ok) {
          throw new Error("Erreur HTTP sur les endpoints macro");
        }

        const summary = await summaryRes.json();
        const raw = await rawRes.json();

        setWeekRange(summary);
        setRiskPillWeekly(summary);
        renderRiskComment(summary);
        renderTopEvents(summary);
        renderTopMoves(summary);
        renderSentimentGrid(raw);

        updateMacroBiasChip();
      } catch (err) {
        console.error("Erreur refreshMacroWeek:", err);
        const el = document.getElementById("risk-comment");
        el.textContent = "Vue macro indisponible pour le moment.";
      }
    }

    /* ---------- MACRO BIAS POUR LA BANDEAU HAUT DASH ---------- */

    async function updateMacroBiasChip() {
      try {
        const resp = await fetch(API_BASE + "/api/macro/bias");
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        const chip = document.getElementById("macro-bias-chip");
        const txt = document.getElementById("macro-bias-text");

        chip.classList.remove("pill-positive", "pill-negative", "pill-neutral");
        if (data.risk_on === true) {
          chip.classList.add("pill-positive");
        } else if (data.risk_on === false) {
          chip.classList.add("pill-negative");
        } else {
          chip.classList.add("pill-neutral");
        }
        txt.textContent = data.comment || "Lecture macro indisponible pour le moment.";
      } catch (e) {
        console.error("Erreur updateMacroBiasChip:", e);
      }
    }

    /* ---------- DASHBOARD LIVE : SNAPSHOTS & PERF ---------- */

    const ASSETS = ["ES", "NQ", "BTC", "CL", "GC"];

    async function fetchSnapshot(symbol) {
      const resp = await fetch(API_BASE + "/latest?symbol=" + encodeURIComponent(symbol));
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      return resp.json();
    }

    async function refreshSnapshots() {
      try {
        const results = await Promise.allSettled(ASSETS.map((s) => fetchSnapshot(s)));
        const miniContainer = document.getElementById("mini-assets");
        miniContainer.innerHTML = "";

        let mainSnapshot = null;

        results.forEach((res, idx) => {
          const sym = ASSETS[idx];
          if (res.status !== "fulfilled") return;
          const snap = res.value;

          if (sym === "ES") mainSnapshot = snap;

          const card = document.createElement("div");
          card.className = "mini-asset";

          const header = document.createElement("div");
          header.className = "mini-asset-header";

          const name = document.createElement("div");
          name.className = "mini-asset-name";
          name.textContent = snap.label || sym;

          const changeEl = document.createElement("div");
          const ch = snap.change_pct ?? 0;
          const sign = ch > 0 ? "+" : "";
          changeEl.textContent = sign + ch.toFixed(2) + " %";
          changeEl.className =
            ch > 0
              ? "mini-asset-change-pos"
              : ch < 0
              ? "mini-asset-change-neg"
              : "mini-asset-change-neutral";

          header.appendChild(name);
          header.appendChild(changeEl);

          const price = document.createElement("div");
          price.className = "mini-asset-price";
          price.textContent = (snap.price ?? 0).toFixed(2);

          const comment = document.createElement("div");
          comment.className = "mini-asset-comment";
          comment.textContent = snap.comment || "Pas de commentaire disponible.";

          card.appendChild(header);
          card.appendChild(price);
          card.appendChild(comment);
          miniContainer.appendChild(card);
        });

        if (mainSnapshot) {
          const priceEl = document.getElementById("main-price");
          const changeEl = document.getElementById("main-change");
          priceEl.textContent = (mainSnapshot.price ?? 0).toFixed(2);

          const ch = mainSnapshot.change_pct ?? 0;
          const sign = ch > 0 ? "+" : "";
          changeEl.textContent = sign + ch.toFixed(2) + " %";
          changeEl.className =
            ch > 0
              ? "main-change-pos"
              : ch < 0
              ? "main-change-neg"
              : "main-change-neutral";
        }

        const ts = new Date();
        document.getElementById("market-last-update").textContent =
          "Derni√®re mise √† jour : " +
          ts.toLocaleTimeString("fr-FR", {
            hour: "2-digit",
            minute: "2-digit",
          });
      } catch (e) {
        console.error("Erreur refreshSnapshots:", e);
        document.getElementById("backend-status").textContent =
          "Impossible de mettre √† jour les donn√©es march√©s pour le moment.";
        document.getElementById("backend-status").classList.remove("status-ok");
      }
    }

    async function refreshPerfSummary() {
      try {
        const resp = await fetch(API_BASE + "/perf/summary");
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        document.getElementById("perf-as-of").textContent = data.as_of || "‚Äî";

        const body = document.getElementById("perf-summary-body");
        body.innerHTML = "";

        (data.assets || []).forEach((a) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = a.label || a.symbol || "‚Äî";

          const tdD = document.createElement("td");
          const tdW = document.createElement("td");
          const tdM = document.createElement("td");

          const setCell = (td, val) => {
            if (val === null || val === undefined) {
              td.textContent = "‚Äî";
              td.className = "perf-neutral";
            } else {
              const sign = val > 0 ? "+" : "";
              td.textContent = sign + val.toFixed(2) + " %";
              td.className =
                val > 0 ? "perf-positive" : val < 0 ? "perf-negative" : "perf-neutral";
            }
          };

          setCell(tdD, a.d);
          setCell(tdW, a.w);
          setCell(tdM, a.m);

          tr.appendChild(tdName);
          tr.appendChild(tdD);
          tr.appendChild(tdW);
          tr.appendChild(tdM);
          body.appendChild(tr);
        });

        document.getElementById("perf-error").style.display = "none";
      } catch (e) {
        console.error("Erreur refreshPerfSummary:", e);
        document.getElementById("perf-error").style.display = "block";
      }
    }

    /* ---------- ASSISTANT IA ---------- */

    async function runIaAnalysis() {
      const select = document.getElementById("ia-asset-select");
      const symbol = select.value || "ES";
      const out = document.getElementById("ia-output");
      out.textContent = "Analyse en cours pour " + symbol + "‚Ä¶";

      try {
        const resp = await fetch(API_BASE + "/analyze?symbol=" + encodeURIComponent(symbol));
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        out.textContent = data.analysis || "Aucune analyse renvoy√©e par l'assistant.";
      } catch (e) {
        console.error("Erreur runIaAnalysis:", e);
        out.textContent =
          "Impossible de g√©n√©rer l'analyse IA pour le moment. V√©rifie le backend OpenAI.";
      }
    }

    /* ---------- NEWS IA (NOUVELLE VERSION) ---------- */

    let NEWS_IMPACT_BY_ASSET = {};

    function applyRiskTonePill(riskTone) {
      const pill = document.getElementById("news-tone-pill");
      const label = document.getElementById("news-tone-label");
      pill.classList.remove("pill-positive", "pill-negative", "pill-neutral");

      if (riskTone === "risk_on") {
        pill.classList.add("pill-positive");
        label.textContent = "Tonalit√© risk-on";
      } else if (riskTone === "risk_off") {
        pill.classList.add("pill-negative");
        label.textContent = "Tonalit√© risk-off";
      } else {
        pill.classList.add("pill-neutral");
        label.textContent = "Tonalit√© neutre / mitig√©e";
      }
    }

    function applyVolPill(volOutlook) {
      const pill = document.getElementById("news-vol-pill");
      const label = document.getElementById("news-vol-label");
      pill.classList.remove("pill-positive", "pill-negative", "pill-neutral");

      if (volOutlook === "high") {
        pill.classList.add("pill-negative");
        label.textContent = "Volatilit√© : √©lev√©e";
      } else if (volOutlook === "low") {
        pill.classList.add("pill-positive");
        label.textContent = "Volatilit√© : faible";
      } else {
        pill.classList.add("pill-neutral");
        label.textContent = "Volatilit√© : normale";
      }
    }

    function populateImpactSelect(byAsset) {
      const select = document.getElementById("news-asset-select");
      select.innerHTML = "";

      const entries = Object.entries(byAsset || {});
      if (entries.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucun actif disponible";
        select.appendChild(opt);
        updateImpactPanel(null);
        return;
      }

      const labels = {
        ES: "ES ‚Äì S&P 500 Future",
        NQ: "NQ ‚Äì Nasdaq 100 Future",
        BTC: "BTC ‚Äì Bitcoin",
        CL: "CL ‚Äì Crude Oil (WTI)",
        GC: "GC ‚Äì Gold",
      };

      entries.forEach(([sym]) => {
        const opt = document.createElement("option");
        opt.value = sym;
        opt.textContent = labels[sym] || sym;
        select.appendChild(opt);
      });

      select.onchange = (e) => updateImpactPanel(e.target.value);
      updateImpactPanel(entries[0][0]);
    }

    function updateImpactPanel(symbol) {
      const info = symbol ? (NEWS_IMPACT_BY_ASSET && NEWS_IMPACT_BY_ASSET[symbol]) : null;
      const badge = document.getElementById("news-impact-bias");
      const commentEl = document.getElementById("news-impact-comment");

      badge.classList.remove("bullish", "bearish", "neutral");

      if (!info) {
        badge.textContent = "Biais : ‚Äî";
        badge.classList.add("neutral");
        commentEl.textContent =
          "Pas de commentaire sp√©cifique disponible pour cet actif.";
        return;
      }

      const bias = (info.bias || "neutral").toLowerCase();
      if (bias === "bullish") badge.classList.add("bullish");
      else if (bias === "bearish") badge.classList.add("bearish");
      else badge.classList.add("neutral");

      let biasLabel =
        bias === "bullish"
          ? "Biais haussier"
          : bias === "bearish"
          ? "Biais baissier"
          : "Biais neutre";
      badge.textContent = `Biais : ${biasLabel}`;

      commentEl.textContent = info.comment || "Pas de d√©tail fourni par l'IA.";
    }

    function renderNewsAnalysis(data) {
      const analysis = data.analysis || {};
      const macroSent = analysis.macro_sentiment || {};
      const keyPoints = analysis.key_points || [];
      const byAsset = analysis.by_asset || {};
      const riskTone = analysis.risk_tone || "neutral";
      const volOutlook = analysis.volatility_outlook || "normal";

      applyRiskTonePill(riskTone);
      applyVolPill(volOutlook);

      const summaryEl = document.getElementById("news-summary-text");
      summaryEl.textContent =
        macroSent.comment ||
        "Pas de commentaire macro disponible dans l'analyse.";

      const ul = document.getElementById("news-keypoints");
      ul.innerHTML = "";
      keyPoints.forEach((p) => {
        const li = document.createElement("li");
        li.textContent = p;
        ul.appendChild(li);
      });

      const sourceLabel = document.getElementById("news-source-label");
      sourceLabel.textContent = `Source : ${data.news_source || "‚Äî"}`;

      const lastUpdate = document.getElementById("news-last-update");
      if (data.created_at) {
        const d = new Date(data.created_at * 1000);
        lastUpdate.textContent =
          "Derni√®re analyse : " +
          d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
      } else {
        lastUpdate.textContent = "Derni√®re analyse : ‚Äî";
      }

      NEWS_IMPACT_BY_ASSET = byAsset;
      populateImpactSelect(byAsset);
    }

    async function fetchNewsAnalysis() {
      try {
        const resp = await fetch(API_BASE + "/api/news/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ max_articles: 15 }),
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        renderNewsAnalysis(data);
      } catch (e) {
        console.error("Erreur fetchNewsAnalysis:", e);
        const summaryEl = document.getElementById("news-summary-text");
        summaryEl.textContent =
          "Impossible de r√©cup√©rer l'analyse des news pour le moment.";
      }
    }

    /* ---------- CALENDRIER √âCO ---------- */

    function impactClass(impact) {
      if (!impact) return "";
      const lvl = impact.toLowerCase();
      if (lvl === "high") return "calendar-impact-high";
      if (lvl === "medium") return "calendar-impact-medium";
      return "calendar-impact-low";
    }

    async function refreshCalendar() {
      try {
        const [todayRes, nextRes] = await Promise.all([
          fetch(API_BASE + "/api/calendar/today"),
          fetch(API_BASE + "/api/calendar/next"),
        ]);

        const todayBody = document.getElementById("calendar-today-body");
        const nextBody = document.getElementById("calendar-next-body");
        todayBody.innerHTML = "";
        nextBody.innerHTML = "";

        if (!todayRes.ok && !nextRes.ok) {
          const tr1 = document.createElement("tr");
          const td1 = document.createElement("td");
          td1.colSpan = 4;
          td1.style.fontSize = "11px";
          td1.style.color = "#fca5a5";
          td1.textContent =
            "Calendrier √©conomique indisponible (endpoint backend manquant ou erreur).";
          tr1.appendChild(td1);
          todayBody.appendChild(tr1);

          const tr2 = document.createElement("tr");
          const td2 = document.createElement("td");
          td2.colSpan = 4;
          td2.style.fontSize = "11px";
          td2.style.color = "#fca5a5";
          td2.textContent =
            "V√©rifie /api/calendar/today et /api/calendar/next sur ton backend.";
          tr2.appendChild(td2);
          nextBody.appendChild(tr2);
          return;
        }

        const todayData = todayRes.ok ? await todayRes.json() : { events: [] };
        const nextData = nextRes.ok ? await nextRes.json() : { events: [] };

        const todayEvents = todayData.events || [];
        if (todayEvents.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.style.fontSize = "11px";
          td.style.color = "#9ca3af";
          td.textContent = "Aucune publication macro majeure aujourd'hui.";
          tr.appendChild(td);
          todayBody.appendChild(tr);
        } else {
          todayEvents.forEach((ev) => {
            const tr = document.createElement("tr");
            const tdTime = document.createElement("td");
            tdTime.textContent = ev.time || "‚Äî";
            const tdCountry = document.createElement("td");
            tdCountry.textContent = ev.country || "‚Äî";
            const tdEvent = document.createElement("td");
            tdEvent.textContent = ev.title || "√âv√©nement";
            const tdImpact = document.createElement("td");
            tdImpact.textContent = ev.impact || "‚Äî";
            tdImpact.className = impactClass(ev.impact_level || ev.impact);

            tr.appendChild(tdTime);
            tr.appendChild(tdCountry);
            tr.appendChild(tdEvent);
            tr.appendChild(tdImpact);
            todayBody.appendChild(tr);
          });
        }

        const nextEvents = nextData.events || [];
        if (nextEvents.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.style.fontSize = "11px";
          td.style.color = "#9ca3af";
          td.textContent =
            "Aucune publication significative dans les prochains jours.";
          tr.appendChild(td);
          nextBody.appendChild(tr);
        } else {
          nextEvents.forEach((ev) => {
            const tr = document.createElement("tr");
            const tdDate = document.createElement("td");
            tdDate.textContent = ev.date || "‚Äî";
            const tdCountry = document.createElement("td");
            tdCountry.textContent = ev.country || "‚Äî";
            const tdEvent = document.createElement("td");
            tdEvent.textContent = ev.title || "√âv√©nement";
            const tdImpact = document.createElement("td");
            tdImpact.textContent = ev.impact || "‚Äî";
            tdImpact.className = impactClass(ev.impact_level || ev.impact);

            tr.appendChild(tdDate);
            tr.appendChild(tdCountry);
            tr.appendChild(tdEvent);
            tr.appendChild(tdImpact);
            nextBody.appendChild(tr);
          });
        }
      } catch (e) {
        console.error("Erreur refreshCalendar:", e);
      }
    }

    /* ---------- INIT ---------- */

    document.addEventListener("DOMContentLoaded", () => {
      // Macro hebdo
      refreshMacroWeek();

      // Snapshots + perf
      refreshSnapshots();
      refreshPerfSummary();
      updateMacroBiasChip();

      // News IA
      const newsBtn = document.getElementById("news-refresh-btn");
      if (newsBtn) newsBtn.addEventListener("click", fetchNewsAnalysis);
      fetchNewsAnalysis();

      // IA bouton
      const iaBtn = document.getElementById("ia-run-btn");
      if (iaBtn) iaBtn.addEventListener("click", runIaAnalysis);

      // Calendrier
      refreshCalendar();

      // Refresh p√©riodique snapshots
      setInterval(refreshSnapshots, 15000);
    });
  </script>
</body>
</html>
