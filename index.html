<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>STARK TRADING DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #050816;
      color: #f9fafb;
    }

    header {
      padding: 14px 18px;
      border-bottom: 1px solid #1f2937;
      background: #020617;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-weight: 700;
      letter-spacing: 0.08em;
    }

    .page {
      max-width: 1200px;
      margin: auto;
      padding: 16px;
    }

    .grid-main {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 16px;
    }

    .grid-bottom {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .card {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 14px;
    }

    h3 {
      margin: 0 0 6px;
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    /* ---------------- LIVE PRICES ---------------- */

    .price-main {
      font-size: 26px;
      font-weight: 700;
    }

    .change-pos { color: #22c55e; }
    .change-neg { color: #ef4444; }
    .change-neu { color: #9ca3af; }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .mini {
      background: #0b1020;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 8px;
      font-size: 12px;
    }

    /* ---------------- PERF TABLE ---------------- */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px;
      border-bottom: 1px solid #1f2937;
      text-align: right;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    /* ---------------- NEWS ---------------- */

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #374151;
      margin-right: 6px;
    }

    .pill-on { color:#bbf7d0; border-color:#22c55e; }
    .pill-off { color:#fecaca; border-color:#ef4444; }
    .pill-neu { color:#9ca3af; }

    .news-grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .impact-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-block;
      margin-bottom: 6px;
    }

    .bullish { color:#22c55e; border:1px solid #22c55e; }
    .bearish { color:#ef4444; border:1px solid #ef4444; }
    .neutral { color:#9ca3af; border:1px solid #374151; }

    /* ---------------- CALENDAR ---------------- */

    .calendar-block {
      margin-top: 8px;
    }

    .calendar-title {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .calendar-table td {
      font-size: 11px;
    }

    .high { color:#f97316; }
    .medium { color:#eab308; }
    .low { color:#22c55e; }
  </style>
</head>

<body>

<header>
  <div class="brand">STARK TRADING – MACRO</div>
  <div>Backend Render ✓</div>
</header>

<div class="page">

  <!-- ================= LIVE ================= -->
  <div class="grid-main">

    <div class="card">
      <h3>Prix spot</h3>
      <div class="price-main" id="main-price">0.00</div>
      <div id="main-change" class="change-neu">0.00%</div>

      <div class="mini-grid" id="mini-assets"></div>
    </div>

    <div class="card">
      <h3>Performance indices</h3>
      <table>
        <thead>
          <tr>
            <th>Actif</th>
            <th>Jour</th>
            <th>Semaine</th>
            <th>Mois</th>
          </tr>
        </thead>
        <tbody id="perf-summary-body"></tbody>
      </table>
    </div>

  </div>

  <!-- ================= NEWS + CALENDAR ================= -->
  <div class="grid-bottom">

    <div class="card">
      <h3>News & Sentiment IA</h3>

      <div>
        <span id="news-tone" class="pill pill-neu">—</span>
        <span id="news-vol" class="pill pill-neu">Volatilité —</span>
      </div>

      <p id="news-summary" style="margin-top:8px;font-size:13px;">
        Chargement de l’analyse…
      </p>

      <ul id="news-points" style="font-size:12px;"></ul>

      <div class="news-grid">
        <div>
          <h3>Impact par actif</h3>
          <select id="news-asset"></select>
        </div>
        <div>
          <div id="impact-badge" class="impact-badge neutral">—</div>
          <p id="impact-comment" style="font-size:12px;"></p>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Calendrier économique</h3>

      <div class="calendar-block">
        <div class="calendar-title">Aujourd’hui</div>
        <table class="calendar-table">
          <tbody id="cal-today"></tbody>
        </table>
      </div>

      <div class="calendar-block">
        <div class="calendar-title">Prochains jours</div>
        <table class="calendar-table">
          <tbody id="cal-next"></tbody>
        </table>
      </div>
    </div>

  </div>

</div>

<script>
const API = "";

const ASSETS = ["ES","NQ","BTC","CL","GC"];

/* ---------- LIVE ---------- */
async function refreshPrices(){
  const mini = document.getElementById("mini-assets");
  mini.innerHTML = "";

  for(const s of ASSETS){
    const r = await fetch(`/latest?symbol=${s}`);
    const d = await r.json();

    if(s==="ES"){
      document.getElementById("main-price").textContent = d.price.toFixed(2);
      document.getElementById("main-change").textContent =
        d.change_pct.toFixed(2)+"%";
    }

    const div = document.createElement("div");
    div.className="mini";
    div.textContent = `${s} ${d.price.toFixed(2)} (${d.change_pct.toFixed(2)}%)`;
    mini.appendChild(div);
  }
}

/* ---------- PERF ---------- */
async function refreshPerf(){
  const r = await fetch("/perf/summary");
  const data = await r.json();
  const body = document.getElementById("perf-summary-body");
  body.innerHTML="";
  data.forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${a.symbol}</td>
      <td>${a.daily}%</td>
      <td>${a.weekly}%</td>
      <td>${a.monthly}%</td>`;
    body.appendChild(tr);
  });
}

/* ---------- NEWS ---------- */
async function refreshNews(){
  const r = await fetch("/api/news/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:"{}"});
  const d = await r.json();
  const a = d.analysis;

  document.getElementById("news-summary").textContent = a.macro_sentiment.comment;

  const tone=document.getElementById("news-tone");
  tone.textContent=a.risk_tone;
  tone.className="pill "+(a.risk_tone==="risk_on"?"pill-on":a.risk_tone==="risk_off"?"pill-off":"pill-neu");

  const vol=document.getElementById("news-vol");
  vol.textContent="Volatilité "+a.volatility_outlook;

  const ul=document.getElementById("news-points");
  ul.innerHTML="";
  a.key_points.forEach(p=>{
    const li=document.createElement("li");
    li.textContent=p;
    ul.appendChild(li);
  });

  const sel=document.getElementById("news-asset");
  sel.innerHTML="";
  for(const k in a.by_asset){
    const o=document.createElement("option");
    o.value=k;o.textContent=k;
    sel.appendChild(o);
  }

  sel.onchange=()=>updateImpact(a.by_asset[sel.value]);
  updateImpact(a.by_asset[sel.value]);
}

function updateImpact(info){
  const b=document.getElementById("impact-badge");
  b.className="impact-badge "+info.bias;
  b.textContent=info.bias;
  document.getElementById("impact-comment").textContent=info.comment;
}

/* ---------- INIT ---------- */
document.addEventListener("DOMContentLoaded",()=>{
  refreshPrices();
  refreshPerf();
  refreshNews();
  setInterval(refreshPrices,15000);
});
</script>

</body>
</html>
