<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>STARK TRADING DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- =========================
       STYLE (inchangé sauf layout)
       ========================= -->
  <style>
    /* --- variables & base --- */
    :root {
      --bg: #050816;
      --card: #020617;
      --border: #1f2937;
      --accent: #f97316;
      --text: #f9fafb;
      --muted: #9ca3af;
      --success: #22c55e;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 60%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
    }

    .page { max-width: 1200px; margin: 0 auto; padding: 16px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }

    .brand { display:flex; gap:10px; align-items:center; }
    .brand-logo {
      width:34px;height:34px;border-radius:12px;
      background:radial-gradient(circle at 30% 0,#f97316,#7c2d12 55%,#020617);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
    }

    .card {
      background: var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      margin-bottom:16px;
    }

    .card-title { font-weight:600; margin-bottom:4px; }
    .card-sub { font-size:12px; color:var(--muted); }

    /* --- layout --- */
    .grid-main {
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:16px;
    }
    @media(max-width:900px){
      .grid-main { grid-template-columns:1fr; }
    }

    .grid-bottom {
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:16px;
    }
    @media(max-width:900px){
      .grid-bottom { grid-template-columns:1fr; }
    }

    /* --- prices --- */
    .price { font-size:28px; font-weight:600; }
    .pos{color:var(--success)} .neg{color:var(--danger)} .neu{color:var(--muted)}

    /* --- mini assets --- */
    .mini-grid {
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:8px;
      margin-top:12px;
    }
    .mini {
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      font-size:12px;
    }

    /* --- perf table --- */
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th,td { padding:6px; border-bottom:1px solid var(--border); }
    th { color:var(--muted); text-align:left; }

    /* --- news --- */
    .pill {
      display:inline-flex;gap:6px;align-items:center;
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--border);font-size:11px;
    }
    .pill-dot{width:6px;height:6px;border-radius:50%}
    .pill.pos{border-color:var(--success);color:#bbf7d0}
    .pill.neg{border-color:var(--danger);color:#fecaca}
    .pill.neu{color:var(--muted)}

    .news-layout {
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:12px;
      margin-top:8px;
    }
    @media(max-width:900px){
      .news-layout{grid-template-columns:1fr;}
    }

    /* --- calendar --- */
    .calendar-block { margin-top:10px; }
    .calendar-title { font-size:12px;color:var(--muted);margin-bottom:6px; }
  </style>
</head>

<body>

<div class="page">

  <!-- ======================
       HEADER
       ====================== -->
  <header>
    <div class="brand">
      <div class="brand-logo">Δ</div>
      <div>
        <div style="font-weight:600">STARK TRADING</div>
        <div style="font-size:12px;color:var(--muted)">Macro · News · Futures</div>
      </div>
    </div>
  </header>

  <!-- ======================
       LIVE PRICES
       ====================== -->
  <div class="grid-main">

    <section class="card">
      <div class="card-title">ES – S&P 500 Future</div>
      <div class="price" id="main-price">0.00</div>
      <div id="main-change" class="neu">0.00 %</div>

      <div class="mini-grid" id="mini-assets"></div>
    </section>

    <!-- PERF INDICES (resserré) -->
    <section class="card">
      <div class="card-title">Performance indices</div>
      <table>
        <thead>
          <tr><th>Actif</th><th>Jour</th><th>Semaine</th><th>Mois</th></tr>
        </thead>
        <tbody id="perf-summary-body"></tbody>
      </table>
    </section>

  </div>

  <!-- ======================
       NEWS IA V2
       ====================== -->
  <section class="card">
    <div class="card-title">News & Sentiment IA</div>
    <div class="card-sub">Sources mondiales (Reuters, FT, WSJ, Crypto)</div>

    <div style="display:flex;gap:8px;margin-top:8px;">
      <div id="news-tone-pill" class="pill neu">
        <span class="pill-dot"></span>
        <span id="news-tone-label">Tonalité…</span>
      </div>
      <div id="news-vol-pill" class="pill neu">
        <span class="pill-dot"></span>
        <span id="news-vol-label">Volatilité…</span>
      </div>
    </div>

    <div class="news-layout">
      <div>
        <p id="news-summary-text" style="margin-top:8px;">
          Chargement analyse IA…
        </p>
        <ul id="news-keypoints" style="margin-top:8px;font-size:12px;"></ul>
      </div>

      <div>
        <select id="news-asset-select"></select>
        <div id="news-impact-panel" style="margin-top:8px;font-size:12px;"></div>
      </div>
    </div>
  </section>

  <!-- ======================
       CALENDRIER ÉCO
       ====================== -->
  <section class="card">
    <div class="card-title">Calendrier économique</div>

    <div class="calendar-block">
      <div class="calendar-title">AUJOURD’HUI</div>
      <table>
        <tbody id="calendar-today-body"></tbody>
      </table>
    </div>

    <div class="calendar-block">
      <div class="calendar-title">PROCHAINS JOURS</div>
      <table>
        <tbody id="calendar-next-body"></tbody>
      </table>
    </div>
  </section>

</div>

<!-- ======================
     JS
     ====================== -->
<script>
/* ---------- LIVE PRICES ---------- */
const ASSETS=["ES","NQ","BTC","CL","GC"];

async function refreshSnapshots(){
  const mini=document.getElementById("mini-assets");
  mini.innerHTML="";
  for(const s of ASSETS){
    const r=await fetch(`/latest?symbol=${s}`);
    if(!r.ok)continue;
    const d=await r.json();
    const div=document.createElement("div");
    div.className="mini";
    div.innerHTML=`<strong>${s}</strong><br>${(d.price||0).toFixed(2)}<br>${(d.change_pct||0).toFixed(2)} %`;
    mini.appendChild(div);
    if(s==="ES"){
      document.getElementById("main-price").textContent=(d.price||0).toFixed(2);
      document.getElementById("main-change").textContent=(d.change_pct||0).toFixed(2)+" %";
    }
  }
}

/* ---------- PERF ---------- */
async function refreshPerf(){
  const r=await fetch("/perf/summary");
  if(!r.ok)return;
  const data=await r.json();
  const body=document.getElementById("perf-summary-body");
  body.innerHTML="";
  data.forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${a.symbol}</td><td>${a.daily}</td><td>${a.weekly}</td><td>${a.monthly}</td>`;
    body.appendChild(tr);
  });
}

/* ---------- NEWS IA V2 ---------- */
async function fetchNewsV2(){
  const r=await fetch("/api/news/analyze-v2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_articles:25})});
  if(!r.ok)return;
  const d=await r.json();
  document.getElementById("news-summary-text").textContent=d.analysis.macro_sentiment.comment||"—";
  const ul=document.getElementById("news-keypoints");
  ul.innerHTML="";
  (d.analysis.key_points||[]).forEach(p=>{
    const li=document.createElement("li");li.textContent=p;ul.appendChild(li);
  });
}

/* ---------- CALENDAR ---------- */
async function refreshCalendar(){
  const r=await fetch("/api/calendar/summary");
  if(!r.ok)return;
  const d=await r.json();
  const t=document.getElementById("calendar-today-body");
  const n=document.getElementById("calendar-next-body");
  t.innerHTML="";n.innerHTML="";
  d.today.forEach(e=>{
    t.innerHTML+=`<tr><td>${e.time||""}</td><td>${e.country||""}</td><td>${e.event}</td></tr>`;
  });
  d.next_days.forEach(e=>{
    n.innerHTML+=`<tr><td>${e.date}</td><td>${e.country||""}</td><td>${e.event}</td></tr>`;
  });
}

/* ---------- INIT ---------- */
document.addEventListener("DOMContentLoaded",()=>{
  refreshSnapshots();
  refreshPerf();
  fetchNewsV2();
  refreshCalendar();
  setInterval(refreshSnapshots,15000);
});
</script>

</body>
</html>
