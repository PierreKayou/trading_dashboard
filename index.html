<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Stark Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.15);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --card-radius: 18px;
      --transition-fast: 0.15s ease-out;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.45);
    }
    body {
        background: var(--bg);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }

    .app-shell {
      max-width: 1200px;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 20px;
    }

    @media (max-width: 920px) {
      .app-shell {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: radial-gradient(circle at top left, #111827 0, #020617 50%);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 20px 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .title-block h1 {
      font-size: 20px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .title-block p {
      font-size: 13px;
      color: var(--text-muted);
    }

    .tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(249, 115, 22, 0.4);
      white-space: nowrap;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .currency-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .currency-switch {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.35);
      overflow: hidden;
      font-size: 11px;
    }

    .currency-switch button {
      background: transparent;
      color: var(--text-muted);
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
    }

    .currency-switch button.active {
      background: #0f172a;
      color: #f9fafb;
    }

    .main-price {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 6px;
    }

    .main-price-row {
      display: flex;
      align-items: baseline;
      gap: 10px;
      justify-content: space-between;
    }

    .main-symbol {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .main-value {
      font-size: 34px;
      font-weight: 600;
    }

    .main-change {
      font-size: 14px;
      font-weight: 500;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.08);
      color: var(--success);
      white-space: nowrap;
    }

    .main-change.negative {
      background: rgba(239, 68, 68, 0.12);
      color: var(--danger);
    }

    .main-comment {
      font-size: 13px;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }

    .mini-card {
      position: relative;
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148, 163, 184, 0.22);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: default;
      overflow: hidden;
    }

    .mini-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .mini-price {
      font-size: 16px;
      font-weight: 600;
    }

    .mini-change {
      font-size: 13px;
      font-weight: 500;
    }

    .mini-change.positive {
      color: var(--success);
    }

    .mini-change.negative {
      color: var(--danger);
    }

    .mini-comment {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      margin-right: 6px;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    .status {
      display: inline-flex;
      align-items: center;
    }

    .error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 10px;
    }

    /* Panneau droit : Assistant Stark */
    .panel-right-title {
      font-size: 16px;
      font-weight: 600;
    }

    .panel-right-sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .ai-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 8px 0 6px 0;
    }

    .ai-symbol-select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: #020617;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    .ai-button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2563eb;
      color: #e5f0ff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out,
        background 0.1s ease-out;
    }

    .ai-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.45);
      background: #1d4ed8;
    }

    .ai-button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .badge-soon {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .ai-status-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .ai-analysis-box {
      margin-top: 4px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(145deg, #020617, #020617);
      font-size: 13px;
      line-height: 1.5;
      max-height: 340px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .ai-analysis-box h3 {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .ai-analysis-box strong {
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- PANEL GAUCHE : PRIX TEMPS R√âEL -->
    <section class="panel">
      <header class="panel-header">
        <div class="title-block">
          <h1>Stark Trading Dashboard</h1>
          <p>Vue synth√©tique des march√©s ‚Äì ES, NQ, BTC, CL, GC</p>
        </div>
        <div class="tag">B√™ta ‚Äì backend Render</div>
      </header>

      <div class="top-row" style="margin-top: 6px;">
        <div>
          <span style="font-size: 12px; color: var(--text-muted);">
            Contrat principal ‚Äì <span id="main-symbol-label">ES S&amp;P 500 Future</span>
          </span>
        </div>
        <div class="currency-toggle">
          <span id="currency-label">Devise : USD</span>
          <div class="currency-switch">
            <button id="btn-usd" class="active">$</button>
            <button id="btn-eur">‚Ç¨</button>
          </div>
        </div>
      </div>

      <div class="main-price">
        <div class="main-price-row">
          <div>
            <div class="main-value" id="main-price-value">‚Äì</div>
          </div>
          <div id="main-price-change" class="main-change">‚Äì</div>
        </div>
        <p class="main-comment" id="main-price-comment">
          Chargement des donn√©es‚Ä¶
        </p>
      </div>

      <div class="grid" id="instruments-grid">
        <!-- Mini-cartes g√©n√©r√©es en JS -->
      </div>

      <div class="footer-row">
        <span class="status">
          <span class="dot"></span>
          <span id="status-text">
            Backend Render en ligne ‚Äì actualisation auto toutes les 15 s
          </span>
        </span>
        <span id="last-update">Derni√®re mise √† jour : ‚Äî</span>
      </div>

      <div id="error-box" class="error" style="display: none;"></div>
    </section>

    <!-- PANEL DROIT : ASSISTANT IA -->
    <section class="panel">
      <div class="panel-right-title">Assistant Stark ‚Äì Analyse IA (pas un conseil)</div>
      <p class="panel-right-sub">
        G√©n√®re une analyse synth√©tique pour l‚Äôactif s√©lectionn√© √† partir des donn√©es
        temps r√©el (yfinance) r√©cup√©r√©es par ton backend FastAPI.
      </p>

      <div class="badge-soon">
        ‚öôÔ∏è Int√©gration en cours avec FastAPI &amp; OpenAI
      </div>

      <div class="ai-controls">
        <label for="ai-symbol" style="font-size: 13px;">Actif :</label>
        <select id="ai-symbol" class="ai-symbol-select">
          <option value="ES">ES ‚Äì S&amp;P 500 Future</option>
          <option value="NQ">NQ ‚Äì Nasdaq 100 Future</option>
          <option value="BTC">BTC ‚Äì Bitcoin</option>
          <option value="CL">CL ‚Äì Crude Oil (WTI)</option>
          <option value="GC">GC ‚Äì Gold</option>
        </select>

        <button id="ai-analyze-btn" class="ai-button">
          üß† Analyser avec l‚ÄôIA
        </button>
      </div>

      <div class="ai-status-text" id="ai-status-text">
        S√©lectionne un actif puis clique sur <strong>‚ÄúAnalyser avec l‚ÄôIA‚Äù</strong>.
        Le texte g√©n√©r√© reste un sc√©nario th√©orique et ne constitue pas un conseil financier.
      </div>

      <div id="ai-analysis" class="ai-analysis-box">
        Ici s‚Äôafficheront les analyses IA pour l‚Äôactif s√©lectionn√©.
      </div>
    </section>
  </div>

  <script>
    // ============================
    // CONFIG & √âTAT GLOBAL
    // ============================
    const API_BASE = "https://trading-dashboard-d3ao.onrender.com";

    const INSTRUMENTS = {
      ES: { name: "S&P 500 Future" },
      NQ: { name: "Nasdaq 100 Future" },
      BTC: { name: "Bitcoin" },
      CL: { name: "Crude Oil (WTI)" },
      GC: { name: "Gold" },
    };

    // stockage derni√®re valeur brute en USD
    const latestSnapshots = {}; // {symbol: {price, change_pct, comment}}

    let currencyMode = "USD"; // ou "EUR"
    const APPROX_EUR_RATE = 0.92; // approx, pour affichage

    // ============================
    // UTILITAIRES
    // ============================
    function convertPrice(usdPrice) {
      if (usdPrice == null || isNaN(usdPrice)) return null;
      return currencyMode === "USD" ? usdPrice : usdPrice * APPROX_EUR_RATE;
    }

    function formatPrice(value) {
      if (value == null || isNaN(value)) return "‚Äì";
      return value.toLocaleString("fr-FR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    function formatPercent(change) {
      if (change == null || isNaN(change)) return "‚Äì";
      const sign = change > 0 ? "+" : "";
      return sign + change.toFixed(2) + " %";
    }

    function instrumentLabel(symbol) {
      const meta = INSTRUMENTS[symbol];
      if (!meta) return symbol;
      if (symbol === "ES") return "ES S&P 500 Future";
      if (symbol === "NQ") return "NQ Nasdaq 100 Future";
      if (symbol === "BTC") return "BTC Bitcoin";
      if (symbol === "CL") return "CL Crude Oil (WTI)";
      if (symbol === "GC") return "GC Gold";
      return symbol + " " + meta.name;
    }

    // ============================
    // RENDERING DASHBOARD PRIX
    // ============================
    const gridEl = document.getElementById("instruments-grid");
    const mainPriceEl = document.getElementById("main-price-value");
    const mainChangeEl = document.getElementById("main-price-change");
    const mainCommentEl = document.getElementById("main-price-comment");
    const lastUpdateEl = document.getElementById("last-update");
    const errorBox = document.getElementById("error-box");
    const currencyLabel = document.getElementById("currency-label");
    const mainSymbolLabelEl = document.getElementById("main-symbol-label");

    const btnUSD = document.getElementById("btn-usd");
    const btnEUR = document.getElementById("btn-eur");

    function renderCards() {
      gridEl.innerHTML = "";

      // ES comme contrat principal
      const mainSymbol = "ES";
      const mainSnap = latestSnapshots[mainSymbol];

      if (mainSnap) {
        const converted = convertPrice(mainSnap.price);
        mainPriceEl.textContent = formatPrice(converted) + " " + (currencyMode === "USD" ? "$" : "‚Ç¨");
        const pctText = formatPercent(mainSnap.change_pct);
        mainChangeEl.textContent = pctText;
        mainChangeEl.classList.toggle("negative", mainSnap.change_pct < 0);
        mainCommentEl.textContent = mainSnap.comment || "OK";
        mainSymbolLabelEl.textContent = instrumentLabel(mainSymbol);
      } else {
        mainPriceEl.textContent = "‚Äì";
        mainChangeEl.textContent = "‚Äì";
        mainCommentEl.textContent = "Chargement des donn√©es‚Ä¶";
      }

      Object.keys(INSTRUMENTS).forEach((symbol) => {
        const meta = INSTRUMENTS[symbol];
        const snap = latestSnapshots[symbol];

        const card = document.createElement("div");
        card.className = "mini-card";

        const header = document.createElement("div");
        header.className = "mini-header";
        header.innerHTML = `
          <span>${symbol}</span>
          <span>${meta.name.toUpperCase()}</span>
        `;

        const priceRow = document.createElement("div");
        priceRow.style.display = "flex";
        priceRow.style.alignItems = "baseline";
        priceRow.style.justifyContent = "space-between";

        const priceEl = document.createElement("div");
        priceEl.className = "mini-price";

        const changeEl = document.createElement("div");
        changeEl.className = "mini-change";

        if (snap) {
          const converted = convertPrice(snap.price);
          priceEl.textContent =
            formatPrice(converted) + " " + (currencyMode === "USD" ? "$" : "‚Ç¨");
          const pctText = formatPercent(snap.change_pct);
          changeEl.textContent = pctText;
          changeEl.classList.toggle("positive", snap.change_pct > 0);
          changeEl.classList.toggle("negative", snap.change_pct < 0);
        } else {
          priceEl.textContent = "‚Äì";
          changeEl.textContent = "‚Äì %";
        }

        priceRow.appendChild(priceEl);
        priceRow.appendChild(changeEl);

        const commentEl = document.createElement("div");
        commentEl.className = "mini-comment";
        commentEl.textContent = snap?.comment || "En attente de donn√©es‚Ä¶";

        card.appendChild(header);
        card.appendChild(priceRow);
        card.appendChild(commentEl);
        gridEl.appendChild(card);
      });

      const now = new Date();
      lastUpdateEl.textContent =
        "Derni√®re mise √† jour : " +
        now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
    }

    async function fetchLatestForSymbol(symbol) {
      const url = `${API_BASE}/latest?symbol=${encodeURIComponent(symbol)}`;
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Erreur backend pour ${symbol}: ${res.status}`);
      }
      const data = await res.json();
      // data doit contenir price, change_pct, comment
      latestSnapshots[symbol] = {
        price: data.price,
        change_pct: data.change_pct,
        comment: data.comment,
      };
    }

    async function refreshAll() {
      try {
        errorBox.style.display = "none";
        const symbols = Object.keys(INSTRUMENTS);
        await Promise.all(symbols.map((s) => fetchLatestForSymbol(s)));
        renderCards();
      } catch (err) {
        console.error(err);
        errorBox.style.display = "block";
        errorBox.textContent = "Erreur de chargement : " + err.message;
      }
    }

    // currency buttons
    function setCurrency(mode) {
      currencyMode = mode;
      currencyLabel.textContent =
        mode === "USD" ? "Devise : USD" : "Devise : EUR (approx.)";
      btnUSD.classList.toggle("active", mode === "USD");
      btnEUR.classList.toggle("active", mode === "EUR");
      renderCards();
    }

    btnUSD.addEventListener("click", () => setCurrency("USD"));
    btnEUR.addEventListener("click", () => setCurrency("EUR"));

    // ============================
    // ASSISTANT IA (panneau de droite)
    // ============================
    const aiSymbolSelect = document.getElementById("ai-symbol");
    const aiAnalyzeBtn = document.getElementById("ai-analyze-btn");
    const aiStatusText = document.getElementById("ai-status-text");
    const aiAnalysisBox = document.getElementById("ai-analysis");

    function setAIStatus(text) {
      aiStatusText.innerHTML = text;
    }

    function renderAIAnalysis(json) {
      const symbol = json.symbol || aiSymbolSelect.value;
      const snap = json.snapshot || {};
      const analysis = json.analysis || "Aucune analyse retourn√©e.";

      const priceUSD = snap.price;
      const priceConverted = convertPrice(priceUSD);

      let headerText = `Analyse IA pour ${instrumentLabel(symbol)}`;
      let prixText = "";
      if (priceConverted != null) {
        prixText =
          `Prix approx. : ${formatPrice(priceConverted)} ` +
          (currencyMode === "USD" ? "$" : "‚Ç¨") +
          ` (${formatPercent(snap.change_pct)} depuis la derni√®re bougie)`;
      }

      const commentText = snap.comment ? `Commentaire : ${snap.comment}` : "";

      const metaBlock = [
        prixText,
        commentText,
        snap.rsi != null ? `RSI : ${snap.rsi.toFixed(2)}` : null,
      ]
        .filter(Boolean)
        .join(" ¬∑ ");

      aiAnalysisBox.innerHTML =
        `<h3>${headerText}</h3>` +
        (metaBlock ? `<p style="font-size:12px;color:#9ca3af;margin-bottom:6px;">${metaBlock}</p>` : "") +
        `<div>${analysis}</div>`;
    }

    async function runAIAnalysis() {
      const symbol = aiSymbolSelect.value || "ES";
      const url = `${API_BASE}/analyze?symbol=${encodeURIComponent(symbol)}`;

      try {
        aiAnalyzeBtn.disabled = true;
        setAIStatus(
          `Analyse en cours pour <strong>${instrumentLabel(
            symbol
          )}</strong>‚Ä¶`
        );
        aiAnalysisBox.textContent = "Appel en cours √† l‚ÄôAPI IA‚Ä¶";

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`Erreur backend IA : ${res.status}`);
        }
        const json = await res.json();
        renderAIAnalysis(json);

        setAIStatus(
          `Analyse mise √† jour pour <strong>${instrumentLabel(
            symbol
          )}</strong>.`
        );
      } catch (err) {
        console.error(err);
        setAIStatus(
          "Erreur lors de l‚Äôappel IA. V√©rifie le backend ou r√©essaie dans quelques instants."
        );
        aiAnalysisBox.textContent = err.message;
      } finally {
        aiAnalyzeBtn.disabled = false;
      }
    }

    aiAnalyzeBtn.addEventListener("click", runAIAnalysis);

    // ============================
    // INIT
    // ============================
    (function init() {
      setCurrency("USD");
      refreshAll();
      setInterval(refreshAll, 15000);
    })();
  </script>
</body>
</html>
